<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customers - PharmaCare Pro</title>
    <link rel="stylesheet" href="assets/css/modern.css">
    <link rel="stylesheet" href="assets/css/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .data-table th {
            padding: 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-table td {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .data-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .data-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-sm:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .info-message {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .info-message i {
            font-size: 64px;
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .info-message h3 {
            color: #2c3e50;
            margin: 20px 0 10px;
            font-size: 24px;
        }
        
        .info-message p {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 16px;
        }
        
        .info-message .btn {
            padding: 12px 30px;
            font-size: 14px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="brand">
                    <div class="brand-icon">
                        <i class="fas fa-heartbeat"></i>
                    </div>
                    <h1 class="brand-title">PharmaCare Pro</h1>
                </div>
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
            </div>

            <nav class="sidebar-nav">
                <!-- Dashboard Section -->
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <ul>
                        <li class="nav-item">
                            <a href="dashboard_modern.html" class="nav-link">
                                <i class="nav-icon fas fa-tachometer-alt"></i>
                                <span class="nav-text">Dashboard</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Inventory Section -->
                <div class="nav-section" id="inventorySection">
                    <div class="nav-section-title">Inventory</div>
                    <ul>
                        <li class="nav-item">
                            <a href="medicines_modern.html" class="nav-link">
                                <i class="nav-icon fas fa-pills"></i>
                                <span class="nav-text">Medicines</span>
                                <span class="nav-badge" id="lowStockBadge">3</span>
                            </a>
                        </li>
                        <li class="nav-item" id="suppliersNav">
                            <a href="suppliers_modern.html" class="nav-link">
                                <i class="nav-icon fas fa-truck"></i>
                                <span class="nav-text">Suppliers</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Sales Section -->
                <div class="nav-section" id="salesSection">
                    <div class="nav-section-title">Sales</div>
                    <ul>
                        <li class="nav-item">
                            <a href="sales_modern.html" class="nav-link">
                                <i class="nav-icon fas fa-cash-register"></i>
                                <span class="nav-text">Point of Sale</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="customers_modern.html" class="nav-link active">
                                <i class="nav-icon fas fa-users"></i>
                                <span class="nav-text">Customers</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Reports Section -->
                <div class="nav-section" id="reportsSection">
                    <div class="nav-section-title">Analytics</div>
                    <ul>
                        <li class="nav-item">
                            <a href="reports_modern.html" class="nav-link">
                                <i class="nav-icon fas fa-chart-bar"></i>
                                <span class="nav-text">Reports</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Administration Section (Admin Only) -->
                <div class="nav-section" id="adminSection" style="display: none;">
                    <div class="nav-section-title">Administration</div>
                    <ul>
                        <li class="nav-item">
                            <a href="users_modern.html" class="nav-link">
                                <i class="nav-icon fas fa-user-cog"></i>
                                <span class="nav-text">User Management</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="settings_modern.html" class="nav-link">
                                <i class="nav-icon fas fa-cog"></i>
                                <span class="nav-text">Settings</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-title" id="pageTitle">Customer Management</div>
                <div class="header-actions">
                    <button class="notification-btn" onclick="showNotifications()">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationCount">3</span>
                    </button>
                    
                    <!-- User Avatar in Header -->
                    <div class="header-user-profile">
                        <div class="user-avatar" id="headerUserAvatar">A</div>
                        <div class="user-info">
                            <span class="user-name" id="headerUserName">Loading...</span>
                            <span class="user-role" id="headerUserRole">...</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-danger btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </button>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content">
                <!-- Page Header Actions -->
                <div class="page-header">
                    <div class="page-header-content">
                        <div class="page-info">
                            <h2 class="page-title">
                                <i class="fas fa-users page-icon"></i>
                                Customer Management
                            </h2>
                            <p class="page-description">Manage customer profiles, purchase history, and loyalty programs</p>
                        </div>
                        <div class="page-actions" id="customerActions">
                            <button class="btn btn-primary" onclick="showAddCustomerModal()">
                                <i class="fas fa-plus"></i>
                                Add Customer
                            </button>
                            <button class="btn btn-outline" onclick="exportCustomers()">
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Filter and Search Bar -->
                <div class="filters-container">
                    <div class="search-filters">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="customerSearch" placeholder="Search customers..." class="search-input">
                            <button class="search-clear" onclick="clearSearch()" style="display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="filter-group">
                            <select id="statusFilter" class="filter-select">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                            
                            <select id="typeFilter" class="filter-select">
                                <option value="">All Types</option>
                                <option value="regular">Regular</option>
                                <option value="vip">VIP</option>
                                <option value="premium">Premium</option>
                            </select>
                            
                            <button class="btn btn-outline btn-sm" onclick="resetFilters()">
                                <i class="fas fa-refresh"></i>
                                Reset
                            </button>
                        </div>
                    </div>
                    
                    <div class="results-info">
                        <span id="resultsCount">Showing 1-10 of 50 customers</span>
                        <div class="view-toggle">
                            <button class="view-btn active" onclick="setView('grid')" data-view="grid">
                                <i class="fas fa-th-large"></i>
                            </button>
                            <button class="view-btn" onclick="setView('list')" data-view="list">
                                <i class="fas fa-list"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Customers Grid -->
                <div class="customers-container" id="customersContainer">
                    <!-- This will be populated by JavaScript -->
                </div>

                <!-- Pagination -->
                <div class="pagination-container">
                    <div class="pagination-info">
                        <span>Showing <strong>1-10</strong> of <strong>50</strong> customers</span>
                    </div>
                    <div class="pagination">
                        <button class="pagination-btn" disabled>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="pagination-btn active">1</button>
                        <button class="pagination-btn">2</button>
                        <button class="pagination-btn">3</button>
                        <button class="pagination-btn">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="assets/js/main_session_fixed.js"></script>
    <script src="assets/js/page_session_validator.js"></script>
    <script>
        // Simple customers management - you can expand this into a separate file
        class CustomersManager {
            constructor() {
                this.customers = [];
                this.init();
            }
            
            init() {
                this.loadUserData();
                this.loadCustomers();
                this.updateUI();
            }
            
            loadUserData() {
                const userData = localStorage.getItem('user');
                if (userData) {
                    this.currentUser = JSON.parse(userData);
                    this.updateUserDisplay();
                }
            }
            
            updateUserDisplay() {
                if (!this.currentUser) return;
                
                const headerUserName = document.getElementById('headerUserName');
                const headerUserRole = document.getElementById('headerUserRole');
                const headerUserAvatar = document.getElementById('headerUserAvatar');
                
                if (headerUserName) headerUserName.textContent = this.currentUser.full_name || this.currentUser.username;
                if (headerUserRole) headerUserRole.textContent = this.currentUser.role.charAt(0).toUpperCase() + this.currentUser.role.slice(1);
                if (headerUserAvatar) headerUserAvatar.textContent = (this.currentUser.full_name || this.currentUser.username).charAt(0).toUpperCase();
            }
            
            async loadCustomers() {
                try {
                    const response = await fetch('../backend/api/customers.php?action=list', {
                        method: 'GET',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success && data.customers) {
                        this.customers = data.customers;
                        console.log('Loaded customers from database:', this.customers.length);
                    } else {
                        console.error('Failed to load customers:', data.message);
                        this.customers = [];
                    }
                } catch (error) {
                    console.error('Error loading customers:', error);
                    this.customers = [];
                }
                
                this.renderCustomers();
            }
            
            renderCustomers() {
                const container = document.getElementById('customersContainer');
                if (!container) return;
                
                if (this.customers.length === 0) {
                    container.innerHTML = `
                        <div class="info-message">
                            <i class="fas fa-users"></i>
                            <h3>No Customers Yet</h3>
                            <p>Start adding customers to track their purchases and build customer relationships.</p>
                            <button class="btn btn-primary" onclick="showAddCustomerModal()">
                                <i class="fas fa-user-plus"></i> Add First Customer
                            </button>
                        </div>
                    `;
                    return;
                }
                
                // Display customers in a table
                container.innerHTML = `
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Purchases</th>
                                    <th>Total Spent</th>
                                    <th>Last Visit</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${this.customers.map(customer => `
                                    <tr>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;">
                                                    ${(customer.name || 'U').charAt(0).toUpperCase()}
                                                </div>
                                                <div>
                                                    <div style="font-weight: 600; color: #2c3e50;">${customer.name || 'Unknown'}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>${customer.phone || 'N/A'}</td>
                                        <td>${customer.email || 'N/A'}</td>
                                        <td>${customer.purchase_count || 0} purchases</td>
                                        <td style="font-weight: 600; color: #27ae60;">KSh ${parseFloat(customer.total_purchases || 0).toLocaleString('en-KE', {minimumFractionDigits: 2})}</td>
                                        <td>${customer.last_purchase ? new Date(customer.last_purchase).toLocaleDateString('en-GB') : 'Never'}</td>
                                        <td>
                                            <button class="btn btn-sm btn-primary" onclick="viewCustomer(${customer.id})" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-secondary" onclick="editCustomer(${customer.id})" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            updateUI() {
                const resultsCount = document.getElementById('resultsCount');
                if (resultsCount) {
                    resultsCount.textContent = `Showing 1-${this.customers.length} of ${this.customers.length} customers`;
                }
            }
        }
        
        // Global functions
        function showAddCustomerModal() {
            alert('Add customer functionality: This will open a modal to add a new customer. Feature coming soon!');
        }
        
        function viewCustomer(id) {
            window.location.href = `customer_details.html?id=${id}`;
        }
        
        function editCustomer(id) {
            alert(`Edit customer #${id}: This will open a modal to edit customer details. Feature coming soon!`);
        }
        
        function exportCustomers() {
            console.log('Export functionality coming soon');
        }
        
        function setView(viewType) {
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-view="${viewType}"]`).classList.add('active');
        }
        
        function clearSearch() {
            document.getElementById('customerSearch').value = '';
        }
        
        function resetFilters() {
            document.getElementById('customerSearch').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('typeFilter').value = '';
        }
        
        function showNotifications() {
            console.log('Showing notifications...');
        }
        
        function logout() {
            localStorage.removeItem('user');
            localStorage.removeItem('csrf_token');
            window.location.href = 'index.html';
        }
        
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('collapsed');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            new CustomersManager();
        });
    </script>
</body>
</html>
