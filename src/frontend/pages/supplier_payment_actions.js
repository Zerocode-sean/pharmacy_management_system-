        function openReportModal(){document.getElementById('reportModal').style.display='flex';const t=new Date().toISOString().split('T')[0],d=new Date(Date.now()-30*864e5).toISOString().split('T')[0];document.getElementById('reportStartDate').value=d;document.getElementById('reportEndDate').value=t;populateReportSupplierDropdown()}function closeReportModal(){document.getElementById('reportModal').style.display='none'}function populateReportSupplierDropdown(){const s=document.getElementById('reportSupplier');s.innerHTML='<option value="">All Suppliers</option>';suppliers.forEach(r=>s.innerHTML+=`<option value="${r.id}">${r.company_name}</option>`)}async function generateReport(e){e.preventDefault();const API_BASE='../../backend/api';let u=`${API_BASE}/supplier_payments.php?action=report&start_date=${document.getElementById('reportStartDate').value}&end_date=${document.getElementById('reportEndDate').value}`;const s=document.getElementById('reportSupplier').value,p=document.getElementById('reportMethod').value,t=document.getElementById('reportStatus').value;if(s)u+=`&supplier_id=${s}`;if(p)u+=`&payment_method=${p}`;if(t)u+=`&status=${t}`;try{const r=await fetch(u,{credentials:'include'}),d=await r.json();d.success?displayReport(d.report):alert('Error: '+d.message)}catch(o){alert('Failed to generate report')}}function displayReport(r){closeReportModal();const w=window.open('','Report','width=900,height=700'),p=r.payments.map(e=>`<tr><td>${formatDate(e.payment_date)}</td><td>${e.supplier_name}</td><td>KES ${formatMoney(e.amount)}</td><td>${e.payment_method.replace('_',' ').toUpperCase()}</td><td>${e.reference_number||'-'}</td><td>${e.status.toUpperCase()}</td></tr>`).join(''),m=Object.entries(r.by_payment_method).map(([e,t])=>`<tr><td>${e.replace('_',' ').toUpperCase()}</td><td>${t.count}</td><td>KES ${formatMoney(t.total)}</td></tr>`).join(''),s=Object.entries(r.by_status).map(([e,t])=>`<tr><td>${e.toUpperCase()}</td><td>${t.count}</td><td>KES ${formatMoney(t.total)}</td></tr>`).join('');w.document.write(`<!DOCTYPE html><html><head><title>Payment Report</title><style>body{font-family:Arial;padding:20px}h1{color:#2c3e50;border-bottom:3px solid #667eea;padding-bottom:10px}.header{text-align:center;margin-bottom:30px}.summary{background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:30px}.summary-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}.summary-item{text-align:center}.summary-item h3{margin:0;color:#7f8c8d;font-size:14px}.summary-item p{margin:5px 0 0;font-size:24px;font-weight:bold;color:#2c3e50}table{width:100%;border-collapse:collapse;margin:20px 0}th{background:#667eea;color:white;padding:12px;text-align:left}td{padding:10px;border-bottom:1px solid #ddd}tr:hover{background:#f8f9fa}.section{margin:30px 0}.section h2{color:#2c3e50;border-left:4px solid #667eea;padding-left:10px}@media print{.no-print{display:none}}.print-btn{background:#667eea;color:white;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;margin:20px 0}.print-btn:hover{background:#5568d3}</style></head><body><div class="header"><h1>üìä Supplier Payments Report</h1><p>Period: ${formatDate(r.period.start_date)} to ${formatDate(r.period.end_date)}</p><p style="color:#7f8c8d">Generated: ${new Date().toLocaleString()}</p><button class="print-btn no-print" onclick="window.print()">üñ®Ô∏è Print</button></div><div class="summary"><div class="summary-grid"><div class="summary-item"><h3>Total Payments</h3><p>${r.summary.total_payments}</p></div><div class="summary-item"><h3>Total Amount</h3><p>KES ${formatMoney(r.summary.total_amount)}</p></div><div class="summary-item"><h3>Average</h3><p>KES ${formatMoney(r.summary.average_payment)}</p></div></div></div><div class="section"><h2>By Method</h2><table><thead><tr><th>Method</th><th>Count</th><th>Total</th></tr></thead><tbody>${m}</tbody></table></div><div class="section"><h2>By Status</h2><table><thead><tr><th>Status</th><th>Count</th><th>Total</th></tr></thead><tbody>${s}</tbody></table></div><div class="section"><h2>Details</h2><table><thead><tr><th>Date</th><th>Supplier</th><th>Amount</th><th>Method</th><th>Reference</th><th>Status</th></tr></thead><tbody>${p}</tbody></table></div></body></html>`);w.document.close()}async function viewPayment(e){const API_BASE='../../backend/api';try{const t=await fetch(`${API_BASE}/supplier_payments.php?action=payment_details&id=${e}`,{credentials:'include'}),r=await t.json();if(r.success){const a=r.payment;alert(`Payment Details:\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nSupplier: ${a.supplier_name}\nAmount: KES ${formatMoney(a.amount)}\nDate: ${formatDate(a.payment_date)}\nMethod: ${a.payment_method.replace('_',' ').toUpperCase()}\nReference: ${a.reference_number||'N/A'}\nStatus: ${a.status.toUpperCase()}\nPO: ${a.po_number||'N/A'}\nNotes: ${a.notes||'None'}\nCreated: ${a.created_by_name}\n${a.approved_by_name?'Approved: '+a.approved_by_name:''}`)}}catch(n){alert('Failed to load details')}}async function approvePayment(e){const API_BASE='../../backend/api';if(!confirm('Approve this payment? This will update the supplier balance.'))return;try{const t=new FormData;t.append('id',e);const r=await fetch(`${API_BASE}/supplier_payments.php?action=approve`,{method:'POST',credentials:'include',body:t}),a=await r.json();a.success?(alert('‚úÖ Payment approved!'),loadPayments(),loadSuppliers()):alert('Error: '+a.message)}catch(n){alert('Failed')}}async function editPayment(e){alert('Edit feature coming soon...')}async function deletePayment(e){const API_BASE='../../backend/api';if(!confirm('Delete this payment? Cannot be undone.'))return;try{const t=new FormData;t.append('id',e);const r=await fetch(`${API_BASE}/supplier_payments.php?action=delete`,{method:'POST',credentials:'include',body:t}),a=await r.json();a.success?(alert('‚úÖ Deleted!'),loadPayments()):alert('Error: '+a.message)}catch(n){alert('Failed')}}window.onclick=function(e){const t=document.getElementById('paymentModal'),r=document.getElementById('reportModal');e.target===t&&closePaymentModal();e.target===r&&closeReportModal()};
