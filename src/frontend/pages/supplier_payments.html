<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supplier Payments - Pharmacy Admin</title>
    <link rel="stylesheet" href="../assets/css/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .payments-container {
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .page-header h1 {
            color: #2c3e50;
            font-size: 28px;
            margin: 0;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .stat-icon.payments { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-icon.total { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-icon.outstanding { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .stat-icon.pending { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }

        .stat-content h3 {
            margin: 0;
            font-size: 14px;
            color: #7f8c8d;
            font-weight: normal;
        }

        .stat-content p {
            margin: 5px 0 0 0;
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            margin-bottom: 30px;
        }

        .main-content {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .sidebar-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .section-header {
            padding: 20px;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            margin: 0;
            color: #2c3e50;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-controls select,
        .filter-controls input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .payments-table {
            width: 100%;
            border-collapse: collapse;
        }

        .payments-table thead {
            background: #f8f9fa;
        }

        .payments-table th,
        .payments-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        .payments-table th {
            font-weight: 600;
            color: #2c3e50;
            font-size: 13px;
            text-transform: uppercase;
        }

        .payments-table tbody tr:hover {
            background: #f8f9fa;
        }

        .action-btn {
            border: none;
            background: none;
            cursor: pointer;
            padding: 6px 10px;
            margin: 0 2px;
            border-radius: 5px;
            transition: all 0.2s;
            font-size: 14px;
        }

        .action-btn.view {
            color: #3498db;
        }

        .action-btn.view:hover {
            background: #ebf5fb;
        }

        .action-btn.approve {
            color: #27ae60;
        }

        .action-btn.approve:hover {
            background: #eafaf1;
        }

        .action-btn.edit {
            color: #f39c12;
        }

        .action-btn.edit:hover {
            background: #fef5e7;
        }

        .action-btn.delete {
            color: #e74c3c;
        }

        .action-btn.delete:hover {
            background: #fadbd8;
        }

        .method-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .method-bank { background: #d4edda; color: #155724; }
        .method-mpesa { background: #cfe2ff; color: #084298; }
        .method-cash { background: #fff3cd; color: #856404; }
        .method-cheque { background: #e7d4f8; color: #6f42c1; }

        .status-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-cleared { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-bounced { background: #f8d7da; color: #721c24; }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .card h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 16px;
        }

        .supplier-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .supplier-item {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
            cursor: pointer;
            transition: background 0.2s;
        }

        .supplier-item:hover {
            background: #f8f9fa;
        }

        .supplier-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .supplier-balance {
            font-size: 14px;
            color: #e74c3c;
        }

        .supplier-balance.positive {
            color: #27ae60;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            max-width: 700px;
            margin: 50px auto;
            border-radius: 10px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: #2c3e50;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #95a5a6;
        }

        .close-btn:hover {
            color: #e74c3c;
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #ecf0f1;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-cancel {
            background: #95a5a6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-cancel:hover {
            background: #7f8c8d;
        }

        .btn-submit {
            background: #27ae60;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .btn-submit:hover {
            background: #229954;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
        }

        .loading i {
            font-size: 48px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .pending-payments-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .pending-item {
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pending-info h4 {
            margin: 0 0 5px 0;
            color: #2c3e50;
            font-size: 14px;
        }

        .pending-info p {
            margin: 0;
            font-size: 12px;
            color: #7f8c8d;
        }

        .pending-amount {
            font-size: 18px;
            font-weight: bold;
            color: #e74c3c;
        }

        @media (max-width: 1200px) {
            .content-grid {
                grid-template-columns: 1fr;
            }

            .sidebar-content {
                grid-template-columns: repeat(2, 1fr);
                display: grid;
            }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .sidebar-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="payments-container">
        <!-- Page Header -->
        <div class="page-header">
            <div>
                <h1><i class="fas fa-money-bill-wave"></i> Supplier Payments</h1>
                <p style="margin: 5px 0 0 0; color: #7f8c8d;">Track and manage payments to suppliers</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn-primary" onclick="openReportModal()">
                    <i class="fas fa-file-pdf"></i> Generate Report
                </button>
                <button class="btn-primary" onclick="openNewPaymentModal()">
                    <i class="fas fa-plus"></i> Record Payment
                </button>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon payments">
                    <i class="fas fa-hand-holding-usd"></i>
                </div>
                <div class="stat-content">
                    <h3>Total Paid (This Month)</h3>
                    <p id="totalPaid">KES 0</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon total">
                    <i class="fas fa-receipt"></i>
                </div>
                <div class="stat-content">
                    <h3>Payment Count</h3>
                    <p id="paymentCount">0</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon outstanding">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="stat-content">
                    <h3>Total Outstanding</h3>
                    <p id="totalOutstanding">KES 0</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon pending">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <h3>Pending Payments</h3>
                    <p id="pendingCount">0</p>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="content-grid">
            <!-- Payments List -->
            <div class="main-content">
                <div class="section-header">
                    <h2>Recent Payments</h2>
                    <div class="filter-controls">
                        <select id="supplierFilter" onchange="applyFilters()">
                            <option value="">All Suppliers</option>
                        </select>
                        <select id="methodFilter" onchange="applyFilters()">
                            <option value="">All Methods</option>
                            <option value="bank_transfer">Bank Transfer</option>
                            <option value="mpesa">M-Pesa</option>
                            <option value="cash">Cash</option>
                            <option value="cheque">Cheque</option>
                        </select>
                        <input type="date" id="fromDate" onchange="applyFilters()">
                        <input type="date" id="toDate" onchange="applyFilters()">
                    </div>
                </div>

                <div id="paymentsTableContainer">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>Loading payments...</p>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar-content">
                <!-- Supplier Balances -->
                <div class="card">
                    <h3><i class="fas fa-building"></i> Supplier Balances</h3>
                    <div class="supplier-list" id="suppliersList">
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                        </div>
                    </div>
                </div>

                <!-- Pending Payments -->
                <div class="card">
                    <h3><i class="fas fa-hourglass-half"></i> Pending Payments</h3>
                    <div class="pending-payments-list" id="pendingPaymentsList">
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-plus-circle"></i> Record Supplier Payment</h2>
                <button class="close-btn" onclick="closePaymentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="paymentForm" onsubmit="submitPayment(event)">
                    <div class="form-group">
                        <label for="supplierId">Supplier *</label>
                        <select id="supplierId" required>
                            <option value="">Select Supplier</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="paymentDate">Payment Date *</label>
                            <input type="date" id="paymentDate" required>
                        </div>

                        <div class="form-group">
                            <label for="amount">Amount (KES) *</label>
                            <input type="number" id="amount" step="0.01" min="0" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="paymentMethod">Payment Method *</label>
                            <select id="paymentMethod" required onchange="togglePaymentFields()">
                                <option value="">Select Method</option>
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="mpesa">M-Pesa</option>
                                <option value="cash">Cash</option>
                                <option value="cheque">Cheque</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="referenceNumber">Reference Number</label>
                            <input type="text" id="referenceNumber" placeholder="Transaction ID, Receipt No., etc.">
                        </div>
                    </div>

                    <div class="form-row" id="bankFields" style="display:none;">
                        <div class="form-group">
                            <label for="bankName">Bank Name</label>
                            <input type="text" id="bankName" placeholder="e.g., KCB Bank">
                        </div>

                        <div class="form-group">
                            <label for="accountNumber">Account Number</label>
                            <input type="text" id="accountNumber">
                        </div>
                    </div>

                    <div class="form-group" id="chequeField" style="display:none;">
                        <label for="chequeNumber">Cheque Number</label>
                        <input type="text" id="chequeNumber">
                    </div>

                    <div class="form-group">
                        <label for="purchaseOrderId">Link to Purchase Order (Optional)</label>
                        <select id="purchaseOrderId">
                            <option value="">None - General Payment</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" placeholder="Additional details about this payment..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closePaymentModal()">Cancel</button>
                <button type="submit" form="paymentForm" class="btn-submit">
                    <i class="fas fa-check"></i> Record Payment
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '../../backend/api';
        let currentPayments = [];
        let suppliers = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadPayments();
            loadSuppliers();
            loadPendingPayments();
            setDefaultDate();
        });

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('paymentDate').value = today;
        }

        async function loadPayments() {
            try {
                const response = await fetch(`${API_BASE}/supplier_payments.php?action=list`, {
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.success) {
                    currentPayments = data.payments || [];
                    displayPayments(currentPayments);
                    updateStats(data);
                } else {
                    showError(data.message || 'Failed to load payments');
                }
            } catch (error) {
                console.error('Error loading payments:', error);
                showError('Failed to connect to server');
            }
        }

        function displayPayments(payments) {
            const container = document.getElementById('paymentsTableContainer');

            if (payments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>No Payments Recorded</h3>
                        <p>Click "Record Payment" to add your first payment</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="payments-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Supplier</th>
                            <th>Amount</th>
                            <th>Method</th>
                            <th>Reference</th>
                            <th>PO Number</th>
                            <th>Status</th>
                            <th>Created By</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            payments.forEach(payment => {
                const methodClass = `method-${payment.payment_method}`;
                const statusClass = `status-${payment.status}`;
                
                // Action buttons based on status
                let actionButtons = '';
                if (payment.status === 'pending') {
                    actionButtons = `
                        <button onclick="viewPayment(${payment.id})" class="action-btn view" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="approvePayment(${payment.id})" class="action-btn approve" title="Approve Payment">
                            <i class="fas fa-check"></i>
                        </button>
                        <button onclick="editPayment(${payment.id})" class="action-btn edit" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deletePayment(${payment.id})" class="action-btn delete" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                } else {
                    actionButtons = `
                        <button onclick="viewPayment(${payment.id})" class="action-btn view" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                    `;
                }

                html += `
                    <tr>
                        <td>${formatDate(payment.payment_date)}</td>
                        <td>
                            <strong>${payment.supplier_name}</strong><br>
                            <small style="color: #7f8c8d;">${payment.contact_person || ''}</small>
                        </td>
                        <td><strong>KES ${formatMoney(payment.amount)}</strong></td>
                        <td><span class="method-badge ${methodClass}">${payment.payment_method.replace('_', ' ').toUpperCase()}</span></td>
                        <td>${payment.reference_number || '-'}</td>
                        <td>${payment.po_number || '-'}</td>
                        <td><span class="status-badge ${statusClass}">${payment.status.toUpperCase()}</span></td>
                        <td><small>${payment.created_by_name}</small></td>
                        <td style="white-space: nowrap;">
                            ${actionButtons}
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        async function loadSuppliers() {
            try {
                // Load suppliers for the dropdown and sidebar
                const response = await fetch(`${API_BASE}/suppliers.php?action=list`, {
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.suppliers) {
                    suppliers = data.suppliers;
                    populateSupplierDropdowns();
                    displaySupplierBalances();
                }
            } catch (error) {
                console.error('Error loading suppliers:', error);
            }
        }

        function populateSupplierDropdowns() {
            const supplierSelect = document.getElementById('supplierId');
            const filterSelect = document.getElementById('supplierFilter');

            suppliers.forEach(supplier => {
                const option1 = document.createElement('option');
                option1.value = supplier.id;
                option1.textContent = supplier.company_name;
                supplierSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = supplier.id;
                option2.textContent = supplier.company_name;
                filterSelect.appendChild(option2);
            });
        }

        function displaySupplierBalances() {
            const container = document.getElementById('suppliersList');
            
            if (suppliers.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#95a5a6;">No suppliers found</p>';
                return;
            }

            // Sort by outstanding balance (highest first)
            const sorted = [...suppliers].sort((a, b) => 
                parseFloat(b.outstanding_balance || 0) - parseFloat(a.outstanding_balance || 0)
            );

            let html = '';
            sorted.slice(0, 10).forEach(supplier => {
                const balance = parseFloat(supplier.outstanding_balance || 0);
                const balanceClass = balance > 0 ? '' : 'positive';
                
                html += `
                    <div class="supplier-item" onclick="filterBySupplier(${supplier.id})">
                        <div class="supplier-name">${supplier.company_name}</div>
                        <div class="supplier-balance ${balanceClass}">
                            ${balance > 0 ? 'Owes: KES ' + formatMoney(balance) : 'Paid Up'}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        async function loadPendingPayments() {
            try {
                const response = await fetch(`${API_BASE}/supplier_payments.php?action=pending_payments`, {
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.success) {
                    displayPendingPayments(data.pending_payments || []);
                    document.getElementById('pendingCount').textContent = data.count || 0;
                    document.getElementById('totalOutstanding').textContent = 'KES ' + formatMoney(data.total_due || 0);
                }
            } catch (error) {
                console.error('Error loading pending payments:', error);
            }
        }

        function displayPendingPayments(pending) {
            const container = document.getElementById('pendingPaymentsList');

            if (pending.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#95a5a6;">All paid up!</p>';
                return;
            }

            let html = '';
            pending.slice(0, 5).forEach(item => {
                html += `
                    <div class="pending-item">
                        <div class="pending-info">
                            <h4>${item.supplier_name}</h4>
                            <p>PO: ${item.order_number} - ${item.days_overdue} days</p>
                        </div>
                        <div class="pending-amount">
                            KES ${formatMoney(item.amount_due)}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateStats(data) {
            document.getElementById('totalPaid').textContent = 'KES ' + formatMoney(data.total_amount || 0);
            document.getElementById('paymentCount').textContent = data.count || 0;
        }

        function openNewPaymentModal() {
            document.getElementById('paymentModal').style.display = 'block';
            document.getElementById('paymentForm').reset();
            setDefaultDate();
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
        }

        function togglePaymentFields() {
            const method = document.getElementById('paymentMethod').value;
            const bankFields = document.getElementById('bankFields');
            const chequeField = document.getElementById('chequeField');

            bankFields.style.display = method === 'bank_transfer' ? 'flex' : 'none';
            chequeField.style.display = method === 'cheque' ? 'block' : 'none';
        }

        async function submitPayment(event) {
            event.preventDefault();

            const formData = {
                supplier_id: document.getElementById('supplierId').value,
                payment_date: document.getElementById('paymentDate').value,
                amount: document.getElementById('amount').value,
                payment_method: document.getElementById('paymentMethod').value,
                reference_number: document.getElementById('referenceNumber').value,
                bank_name: document.getElementById('bankName').value,
                account_number: document.getElementById('accountNumber').value,
                cheque_number: document.getElementById('chequeNumber').value,
                purchase_order_id: document.getElementById('purchaseOrderId').value || null,
                notes: document.getElementById('notes').value
            };

            try {
                const response = await fetch(`${API_BASE}/supplier_payments.php?action=create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    alert('✅ Payment recorded successfully!');
                    closePaymentModal();
                    loadPayments();
                    loadPendingPayments();
                    loadSuppliers(); // Refresh balances
                } else {
                    alert('❌ Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error submitting payment:', error);
                alert('Failed to submit payment. Please try again.');
            }
        }

        function applyFilters() {
            const supplierId = document.getElementById('supplierFilter').value;
            const method = document.getElementById('methodFilter').value;
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;

            let filtered = currentPayments;

            if (supplierId) {
                filtered = filtered.filter(p => p.supplier_id == supplierId);
            }

            if (method) {
                filtered = filtered.filter(p => p.payment_method === method);
            }

            if (fromDate) {
                filtered = filtered.filter(p => p.payment_date >= fromDate);
            }

            if (toDate) {
                filtered = filtered.filter(p => p.payment_date <= toDate);
            }

            displayPayments(filtered);
        }

        function filterBySupplier(supplierId) {
            document.getElementById('supplierFilter').value = supplierId;
            applyFilters();
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric' 
            });
        }

        function formatMoney(amount) {
            return parseFloat(amount || 0).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function showError(message) {
            document.getElementById('paymentsTableContainer').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-circle" style="color: #e74c3c;"></i>
                    <h3>Error Loading Payments</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        window.onclick = function(event) {
            const modal = document.getElementById('paymentModal');
            if (event.target === modal) {
                closePaymentModal();
            }
        };
    </script>
    <script src="supplier_payment_actions.js"></script>
    
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-file-pdf"></i> Generate Payment Report</h2>
                <button class="close-btn" onclick="closeReportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="reportForm" onsubmit="generateReport(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="reportStartDate">Start Date *</label>
                            <input type="date" id="reportStartDate" required>
                        </div>
                        <div class="form-group">
                            <label for="reportEndDate">End Date *</label>
                            <input type="date" id="reportEndDate" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="reportSupplier">Supplier (Optional)</label>
                        <select id="reportSupplier"><option value="">All Suppliers</option></select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="reportMethod">Payment Method</label>
                            <select id="reportMethod">
                                <option value="">All Methods</option>
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="mpesa">M-Pesa</option>
                                <option value="cash">Cash</option>
                                <option value="cheque">Cheque</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="reportStatus">Status</label>
                            <select id="reportStatus">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="cleared">Cleared</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeReportModal()">Cancel</button>
                <button type="submit" form="reportForm" class="btn-submit">
                    <i class="fas fa-file-download"></i> Generate Report
                </button>
            </div>
        </div>
    </div>
</body>

</html>
